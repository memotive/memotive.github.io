(async function(e,t,n){function o(e){if(e.shiftKey&&9===e.keyCode)V(!1);else if(e.shiftKey||9!==e.keyCode){if(!e.ctrlKey)return;if(82==e.keyCode)G(!1);else if(83==e.keyCode)r("search");else if(90==e.keyCode)r("zoom");else{if(65!=e.keyCode)return;r("align")}}else q(!1);e.preventDefault()}function i(e){if(e.shiftKey&&9===e.keyCode)v(x(ie.index));else if(e.shiftKey||9!==e.keyCode){if(!e.ctrlKey)return;if(82!=e.keyCode)return;v(x(ie.index))}else v(x(ie.index));e.preventDefault()}function r(e){t.getElementById(e).focus()}function l(){const e=[];return n.outputs.forEach((t,n)=>{e.push(t.name)}),e}function s(e){const t=n.getOutputByName(e);return a(t),t}function a(e){e?(t.getElementById("connected").style.display="flex",t.getElementById("disconnected").style.display="none"):(t.getElementById("connected").style.display="none",t.getElementById("disconnected").style.display="flex")}function c(){ie.port||h();let e="List of available MIDI ports:\n"+l().toString().replaceAll(","," / ");e+="\n\nOsmose MIDI Port :";let t=prompt(e,ie.port);null!==t&&(ie.port=t,Q(),s(t)?oe():t&&alert(`Cannot connect to '${t}'.`))}function d(){let e="";return ie.firmware2?f()?e="Osmose Port 1":m()?e="Osmose":g():f()?e="Osmose Port 2":m()?e="MIDIOUT2 (Osmose)":g(),e}function u(){let t="";return t=e.navigator.userAgentData?e.navigator.userAgentData.platform:e.navigator.platform,t.toLowerCase()}function f(){return u().startsWith("mac")}function m(){return u().startsWith("win")}function g(){return u().startsWith("linux")}function h(){let e="OK if Osmose Firmware v2.x installed or Cancel if Firmware v1.x";ie.firmware2=confirm(e),ie.port=d(),Q()}async function y(){let e;e=ie.firmware2?"./osmose-presets-2.json":"./osmose-presets-1.json";const t=await fetch(e),n=await t.json();return n}function p(e){const n=t.getElementById("list");n.replaceChildren(),e.forEach(e=>{const o=t.createElement("div");o.textContent=e.name,o.addEventListener("click",E),o.preset=e,o.className="item",n.appendChild(o)})}function E(e){const t=e.target;t&&(L(t),b(t),M(t,!0),v(t.preset))}function v(e){const t=s(ie.port);t&&(ie.firmware2?t.channels[15].sendControlChange(0,e.cc0).sendProgramChange(e.pc):t.channels[15].sendControlChange(0,e.cc0).sendControlChange(32,e.cc32).sendProgramChange(e.pc)),ie.index=B(e),Q()}function I(){return t.getElementById("list").children}function k(e){const t=I();return t[e]}function x(e){const t=k(e);return t.preset}function B(e){return re.findIndex(t=>t.name==e.name)}function C(e){e.className="item"}function w(e){e.className="highlight"}function L(e){j(e)||(le&&(T(le)?w(le):C(le)),e.className="selected",le=e)}function M(e,t){e&&e.scrollIntoView({behavior:t?"smooth":"auto",block:"center",inline:"center"})}function b(n){if(ie.title){const o=t.getElementById("title"),i=t.getElementById("toolbar");o.innerText=n.preset.name,e.innerWidth<=768&&(o.style.display="flex",i.style.display="none",se&&clearTimeout(se),se=setTimeout(()=>{o.style.display="none",i.style.display="flex"},1e3))}}function O(e){ie.zoom=parseFloat(e.target.value),Q(),z(ie.zoom)}function z(e){t.getElementById("zoom").value=e,t.getElementById("list").style.fontSize=`${e}em`,M(le,!1)}function N(e){ie.align=parseInt(e.target.value),Q(),D(ie.align)}function D(e){t.getElementById("align").value=e;const n=1===e?"left":2===e?"center":"right",o=I();for(let e=0;e<o.length;e++)o[e].style.textAlign=n}function K(e){let t=e.target.value;return"!restart"===t?(S(""),void oe()):"!reset"===t?(S(""),void ne()):"!dark"===t?(_("dark"),Z("dark"),void S("")):"!light"===t?(_("light"),Z("light"),void S("")):("!title"===t&&(ie.title=!ie.title,b(k(ie.index)),t=""),S(t),void P(t))}function S(e){t.getElementById("search").value=e,ie.search=e,Q()}function P(e){t.getElementById("search").value=e;const n=I();for(let e=0;e<n.length;e++){const t=n[e];j(t)||(T(t)?w(t):C(t))}let o=re.length;ie.search&&(o=$().length),t.title=`Osmose Presets v${ie.firmware2?2:1} (${o})`}function W(){return t.getElementById("search").value}function A(){return t.getElementById("search").value.length>0}function T(e){return A()&&e.innerText.includes(W())}function $(){let e=[];const t=I();for(let n=0;n<t.length;n++){const o=t[n];T(o)&&e.push(n)}return e}function j(e){return"selected"===e.className}function F(e){return"highlight"===e.className}function J(){let e=-1;const t=I();for(let n=ie.index+1;n<t.length;n++){const o=t[n];if(!A()){e=n;break}if(F(o)){e=n;break}}return e}function U(){const e=I();let t=-1;for(let n=ie.index-1;n>=0;n--){const o=e[n];if(!A()){t=n;break}if(F(o)){t=n;break}}return t}function V(e=!0){const t=U();-1!==t&&H(t,e)}function q(e=!0){const t=J();-1!==t&&H(t,e)}function G(e=!0){let t;const n=$();A()&&n.length>0?(t=Math.floor(Math.random()*n.length),t===ie.index&&(t=Math.floor(Math.random()*n.length)),H(n[t],e)):A()||(t=Math.floor(Math.random()*re.length),t===ie.index&&(t=Math.floor(Math.random()*re.length)),H(t,e))}function H(e,t=!0){ie.index=e;const n=k(e);L(n),b(n),M(n,!0),t&&v(n.preset)}function Q(){localStorage.setItem("state",JSON.stringify(ie))}function R(){const e=localStorage.getItem("state");let t;return null===e?t={port:"",firmware2:!1,title:!0,index:0,search:"",zoom:1,align:1,theme:""}:"string"==typeof e&&(t=JSON.parse(e)),t}function X(){localStorage.removeItem("state")}function Y(e){_(ie.theme)}function Z(e){ie.theme=e,Q()}function _(n){const o=e.matchMedia("(prefers-color-scheme: dark)");n||(n=o.matches?"dark":"light"),t.documentElement.setAttribute("data-theme",n)}function ee(n){const o=t.getElementById("title");e.innerWidth<=768?o.style.display="none":o.style.display="flex";const i=k(ie.index);i&&M(i,!1)}function te(){_(ie.theme),ie.index>=0&&H(ie.index,!0),s(ie.port),P(ie.search),z(ie.zoom),D(ie.align)}function ne(){X(),oe()}function oe(){e.location.reload()}await n.enable();let ie=R();const re=await y();p(re),t.body.addEventListener("keydown",o),t.body.addEventListener("keyup",i),t.getElementById("connected").addEventListener("click",c),t.getElementById("disconnected").addEventListener("click",c);let le=null,se=null;t.getElementById("zoom").addEventListener("input",O),t.getElementById("align").addEventListener("input",N),t.getElementById("search").addEventListener("input",K),t.getElementById("previous").addEventListener("click",V),t.getElementById("next").addEventListener("click",q),t.getElementById("random").addEventListener("click",G),e.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",Y),e.addEventListener("resize",ee),te()})(window,document,WebMidi);