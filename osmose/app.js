(async function(e,t,n){function o(e){if(e.shiftKey&&9===e.keyCode)U(!1);else if(e.shiftKey||9!==e.keyCode){if(!e.ctrlKey)return;if(82==e.keyCode)q(!1);else if(83==e.keyCode)r("search");else if(90==e.keyCode)r("zoom");else{if(65!=e.keyCode)return;r("align")}}else V(!1);e.preventDefault()}function i(e){if(e.shiftKey&&9===e.keyCode)E(k(oe.index));else if(e.shiftKey||9!==e.keyCode){if(!e.ctrlKey)return;if(82==e.keyCode)E(k(oe.index));else if(83==e.keyCode);else if(90==e.keyCode);else if(65!=e.keyCode)return}else E(k(oe.index));e.preventDefault()}function r(e){t.getElementById(e).focus()}function l(){const e=[];return n.outputs.forEach((t,n)=>{e.push(t.name)}),e}function s(e){const o=n.getOutputByName(e);return o?(t.getElementById("connected").style.display="flex",t.getElementById("disconnected").style.display="none"):(t.getElementById("connected").style.display="none",t.getElementById("disconnected").style.display="flex"),o}function a(){oe.port||g();let e="List of available MIDI ports:\n"+l().toString().replaceAll(","," / ");e+="\n\nOsmose MIDI Port :";let t=prompt(e,oe.port);null!==t&&(oe.port=t,H(),t&&!s(t)&&alert(`Cannot connect to '${t}'.`),ne())}function c(){let e="";return oe.firmware2?u()?e="Osmose Port 1":f()?e="Osmose":m():u()?e="Osmose Port 2":f()?e="MIDIOUT2 (Osmose)":m(),e}function d(){let t="";return t=e.navigator.userAgentData?e.navigator.userAgentData.platform:e.navigator.platform,t.toLowerCase()}function u(){return d().startsWith("mac")}function f(){return d().startsWith("win")}function m(){return d().startsWith("linux")}function g(){let e="Is Osmose Firmware v2 installed ? ";oe.firmware2=confirm(e),oe.port=c(),H()}async function h(){let e;e=oe.firmware2?"./osmose-presets-2.json":"./osmose-presets-1.json";const t=await fetch(e),n=await t.json();return n}function y(e){const n=t.getElementById("list");n.replaceChildren(),e.forEach(e=>{const o=t.createElement("div");o.textContent=e.name,o.addEventListener("click",p),o.preset=e,o.className="item",n.appendChild(o)})}function p(e){const t=e.target;t&&(w(t),M(t),L(t,!0),E(t.preset))}function E(e){const t=s(oe.port);t&&(oe.firmware2?t.channels[15].sendControlChange(0,e.cc0).sendProgramChange(e.pc):t.channels[15].sendControlChange(0,e.cc0).sendControlChange(32,e.cc32).sendProgramChange(e.pc)),oe.index=x(e),H()}function v(){return t.getElementById("list").children}function I(e){const t=v();return t[e]}function k(e){const t=I(e);return t.preset}function x(e){return ie.findIndex(t=>t.name==e.name)}function B(e){e.className="item"}function C(e){e.className="highlight"}function w(e){$(e)||(re&&(A(re)?C(re):B(re)),e.className="selected",re=e)}function L(e,t){e&&e.scrollIntoView({behavior:t?"smooth":"auto",block:"center",inline:"center"})}function M(n){if(oe.title){const o=t.getElementById("title"),i=t.getElementById("toolbar");o.innerText=n.preset.name,e.innerWidth<=768&&(o.style.display="flex",i.style.display="none",le&&clearTimeout(le),le=setTimeout(()=>{o.style.display="none",i.style.display="flex"},1e3))}}function b(e){oe.zoom=parseFloat(e.target.value),H(),O(oe.zoom)}function O(e){t.getElementById("zoom").value=e,t.getElementById("list").style.fontSize=`${e}em`,L(re,!1)}function z(e){oe.align=parseInt(e.target.value),H(),N(oe.align)}function N(e){t.getElementById("align").value=e;const n=1===e?"left":2===e?"center":"right",o=v();for(let e=0;e<o.length;e++)o[e].style.textAlign=n}function D(e){let t=e.target.value;return"!restart"===t?(S(""),void ne()):"!reset"===t?(S(""),void te()):"!dark"===t?(Z("dark"),Y("dark"),void S("")):"!light"===t?(Z("light"),Y("light"),void S("")):("!title"===t&&(oe.title=!oe.title,M(I(oe.index)),t=""),S(t),void K(t))}function S(e){t.getElementById("search").value=e,oe.search=e,H()}function K(e){const n=v();for(let e=0;e<n.length;e++){const t=n[e];$(t)||(A(t)?C(t):B(t))}let o=ie.length;oe.search&&(o=T().length),t.title=`Osmose Presets v${oe.firmware2?2:1} (${o})`}function P(){return t.getElementById("search").value}function W(){return t.getElementById("search").value.length>0}function A(e){return W()&&e.innerText.includes(P())}function T(){let e=[];const t=v();for(let n=0;n<t.length;n++){const o=t[n];A(o)&&e.push(n)}return e}function $(e){return"selected"===e.className}function j(e){return"highlight"===e.className}function F(){let e=-1;const t=v();for(let n=oe.index+1;n<t.length;n++){const o=t[n];if(!W()){e=n;break}if(j(o)){e=n;break}}return e}function J(){const e=v();let t=-1;for(let n=oe.index-1;n>=0;n--){const o=e[n];if(!W()){t=n;break}if(j(o)){t=n;break}}return t}function U(e=!0){const t=J();-1!==t&&G(t,e)}function V(e=!0){const t=F();-1!==t&&G(t,e)}function q(e=!0){let t;const n=T();W()&&n.length>0?(t=Math.floor(Math.random()*n.length),t===oe.index&&(t=Math.floor(Math.random()*n.length)),G(n[t],e)):W()||(t=Math.floor(Math.random()*ie.length),t===oe.index&&(t=Math.floor(Math.random()*ie.length)),G(t,e))}function G(e,t=!0){oe.index=e;const n=I(e);w(n),M(n),L(n,!0),t&&E(n.preset)}function H(){localStorage.setItem("state",JSON.stringify(oe))}function Q(){const e=localStorage.getItem("state");let t;return null===e?t={port:"",firmware2:!1,title:!0,index:0,search:"",zoom:1,align:1,theme:""}:"string"==typeof e&&(t=JSON.parse(e)),t}function R(){localStorage.removeItem("state")}function X(e){Z(oe.theme)}function Y(e){oe.theme=e,H()}function Z(n){const o=e.matchMedia("(prefers-color-scheme: dark)");n||(n=o.matches?"dark":"light"),t.documentElement.setAttribute("data-theme",n)}function _(n){const o=t.getElementById("title");e.innerWidth<=768?o.style.display="none":o.style.display="flex";const i=I(oe.index);i&&L(i,!1)}function ee(){Z(oe.theme),oe.index>=0&&G(oe.index,!0),s(oe.port),K(oe.search),O(oe.zoom),N(oe.align)}function te(){R(),ne()}function ne(){e.location.reload()}await n.enable();let oe=Q();const ie=await h();y(ie),t.body.addEventListener("keydown",o),t.body.addEventListener("keyup",i),t.getElementById("connected").addEventListener("click",a),t.getElementById("disconnected").addEventListener("click",a);let re=null,le=null;t.getElementById("zoom").addEventListener("input",b),t.getElementById("align").addEventListener("input",z),t.getElementById("search").addEventListener("input",D),t.getElementById("previous").addEventListener("click",U),t.getElementById("next").addEventListener("click",V),t.getElementById("random").addEventListener("click",q),e.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",X),e.addEventListener("resize",_),ee()})(window,document,WebMidi);