(async function(e,t,n){function o(e){if(e.shiftKey&&9===e.keyCode)R(!1);else if(e.shiftKey||9!==e.keyCode){if(!e.ctrlKey)return;if(13==e.keyCode)k();else if(84==e.keyCode)v();else if(82==e.keyCode)Y(!1);else if(83==e.keyCode)r("search");else if(90==e.keyCode)r("zoom");else{if(65!=e.keyCode)return;$()}}else X(!1);e.preventDefault()}function i(e){if(e.shiftKey&&9===e.keyCode)C(L(fe.index));else if(e.shiftKey||9!==e.keyCode){if(!e.ctrlKey)return;if(82!=e.keyCode)return;C(L(fe.index))}else C(L(fe.index));e.preventDefault()}function r(e){ce(e).focus()}function s(){const e=[];return n.outputs.forEach((t,n)=>{e.push(t.name)}),e}function l(e){const t=n.getOutputByName(e);return a(t),t}function a(e){e?(ce("connected").style.display="flex",ce("disconnected").style.display="none"):(ce("connected").style.display="none",ce("disconnected").style.display="flex")}function c(){let t=!1;fe.port||(t=y());const n="List of available MIDI ports:\n"+s().toString().replaceAll(","," / ")+"\n\n";if(fe.firmware2){const t="Osmose Port 1:",o=e.prompt(n+t,fe.port);if(null===o)return;if(fe.port=o,_(),o&&!l(o))return void e.alert(`Cannot connect to '${o}'.`)}const o="Osmose Port 2:",i=e.prompt(n+o,fe.port2);null!==i&&(fe.port2=i,_(),!i||l(i)?(fe.firmware2||(fe.port=fe.port2,_()),t?ae():Z(fe.index,!0)):e.alert(`Cannot connect to '${i}'.`))}function f(e){let t="";return fe.firmware2&&1===e?d()?t="Osmose Port 1":h()?t="Osmose":m():d()?t="Osmose Port 2":h()?t="MIDIOUT2 (Osmose)":m(),t}function u(){let t="";return t=e.navigator.userAgentData?e.navigator.userAgentData.platform:e.navigator.platform,t.toLowerCase()}function d(){return u().startsWith("mac")}function h(){return u().startsWith("win")}function m(){return u().startsWith("linux")}function y(){let t="Is Osmose Firmware v2.x installed?";const n=e.confirm(t),o=fe.firmware2!==n;return fe.firmware2=n,fe.port=f(1),fe.port2=f(2),_(),o}async function p(e){let t;t=e?"./osmose-presets-2.json":"./osmose-presets-1.json";const n=await fetch(t),o=await n.json();return o}function g(e){const n=ce("list");n.replaceChildren(),e.forEach(e=>{const o=t.createElement("div");o.textContent=e.name,o.addEventListener("click",v),o.addEventListener("dblclick",k),o.preset=e,o.className="item",n.appendChild(o)})}function k(e){const t=e&&e.target?e.target:E(fe.index);t&&x(t)}function v(e){const t=e&&e.target?e.target:E(fe.index);t&&(q(t)?b(fe.transpose?60:fe.keynote,!1):x(t))}function x(e){z(e),M(e,!0),C(e.preset)}function C(e){const t=l(fe.port);t&&(fe.firmware2?t.sendControlChange(0,e.cc0).sendProgramChange(e.pc):t.channels[16].sendControlChange(0,e.cc0).sendControlChange(32,e.cc32).sendProgramChange(e.pc)),fe.index=O(e),fe.transpose=!1,P(e.name),_()}function b(e,t=!0){const n=E(fe.index).preset;if(60===e&&60===fe.keynote)return P(n.name);const o=l(fe.port2);o&&o.channels[16].sendControlChange(44,e),fe.transpose=60!==e,t&&(fe.keynote=e),P(n.name),_()}function w(){return ce("list").children}function E(e){const t=w();return t[e]}function L(e){const t=E(e);return t.preset}function O(e){return ue.findIndex(t=>t.name==e.name)}function N(e){e.className="item"}function I(e){e.className="highlight"}function z(e){q(e)||(de&&(U(de)?I(de):N(de)),e.className="selected",de=e)}function M(e,t){e&&e.scrollIntoView({behavior:t?"smooth":"auto",block:"center",inline:"center"})}function P(t){if(fe.transpose){const e=fe.keynote-60,n=` (${e>0?"+":""}${e})`;ce("title").innerText=t+n}else ce("title").innerText=t;fe.title&&e.innerWidth<=768&&(ce("header").style.justifyContent="center",ce("toolbar").style.display="none",ce("title").style.display="block",he&&clearTimeout(he),he=setTimeout(()=>{ce("title").style.display="none",ce("toolbar").style.display="flex"},1e3))}function S(e){fe.zoom=parseFloat(e.target.value),_(),T(fe.zoom)}function T(e){ce("zoom").value=e,ce("list").style.fontSize=`${e}em`,M(de,!1)}function $(){fe.align=fe.align>=3?1:fe.align+1,_(),j(fe.align)}function j(e){ce("align-left").style.display="none",ce("align-center").style.display="none",ce("align-right").style.display="none",1===e?ce("align-left").style.display="block":2===e?ce("align-center").style.display="block":ce("align-right").style.display="block";const t=1===e?"left":2===e?"center":"right",n=w();for(let e=0;e<n.length;e++)n[e].style.textAlign=t}function D(e){J("search")}function K(e){let t=e.target.value;const[n,o]=t.split("!");if("reset"===o)return W(""),void le();if("restart"===o)return W(n),void ae();if("off"!==o){if("dark"===o)return W(n),ie("dark"),void oe("dark");if("light"===o)return W(n),ie("light"),void oe("light");if("auto"===o)return W(n),ie(""),void oe("");if("title"===o)fe.title=!fe.title,P(E(fe.index).preset.name);else if("scroll"===o)fe.scroll=!fe.scroll;else if("string"==typeof o){const t=parseInt(o);if(t>=-48&&t<=48){const e=60+t;b(e,!0),fe.keynote=e,W(n)}else if(isNaN(t))try{const t=Utilities.toNoteNumber(o);b(t,!0),fe.keynote=t,W(n)}catch(e){}return}W(n),A(n)}else W(n)}function W(e){ce("search").value=e,fe.search=e,_()}function A(e){ce("search").value=e;const n=w();for(let e=0;e<n.length;e++){const t=n[e];q(t)||(U(t)?I(t):N(t))}let o=ue.length;fe.search&&(o=V().length),t.title=`Osmose Presets v${fe.firmware2?2:1} (${o})`}function B(){return ce("search").value}function F(){return ce("search").value.length>0}function J(e){ce(e).readOnly=!0,ce(e).disabled=!0,setTimeout(function(){ce(e).blur(),ce(e).readOnly=!1,ce(e).disabled=!1},100)}function U(e){return F()&&e.innerText.includes(B())}function V(){let e=[];const t=w();for(let n=0;n<t.length;n++){const o=t[n];U(o)&&e.push(n)}return e}function q(e){return"selected"===e.className}function G(e){return"highlight"===e.className}function H(e=fe.index+1){let t=-1;const n=w();for(let o=e;o<n.length;o++){if(!F()){t=o;break}if(G(n[o])){t=o;break}}return fe.scroll&&-1===t&&(t=H(0)),t}function Q(e=fe.index-1){let t=-1;const n=w();for(let o=e;o>=0;o--){if(!F()){t=o;break}if(G(n[o])){t=o;break}}return fe.scroll&&-1===t&&(t=Q(n.length-1)),t}function R(e=!0){const t=Q();-1!==t&&Z(t,e)}function X(e=!0){const t=H();-1!==t&&Z(t,e)}function Y(e=!0){let t;const n=V();if(F()&&n.length>1){if(t=Math.floor(Math.random()*n.length),n[t]===fe.index)return Y(e);Z(n[t],e)}else if(!F()&&ue.length>1){if(t=Math.floor(Math.random()*ue.length),t===fe.index)return Y(e);Z(t,e)}}function Z(e,t=!0){if(e<0||e>=ue.length)return;fe.index=e;const n=E(e);z(n),M(n,!0),t&&C(n.preset)}function _(){localStorage.setItem("state",JSON.stringify(fe))}function ee(){const e=localStorage.getItem("state");let t;return null===e?t={port:"",port2:"",firmware2:!1,title:!0,scroll:!1,transpose:!1,keynote:60,index:0,search:"",zoom:1,align:1,theme:""}:"string"==typeof e&&(t=JSON.parse(e)),t}function te(){localStorage.removeItem("state")}function ne(e){oe(fe.theme)}function oe(n){if(!n){const t=e.matchMedia("(prefers-color-scheme: dark)").matches;n=t?"dark":"light"}t.documentElement.setAttribute("data-theme",n)}function ie(e){fe.theme=e,_()}function re(t){e.innerWidth<=768?(ce("header").style.justifyContent="center",ce("title").style.display="none"):(ce("header").style.justifyContent="space-between",ce("title").style.display="flex");const n=E(fe.index);n&&M(n,!1)}function se(){oe(fe.theme),Z(fe.index,!0),l(fe.port),l(fe.port2),A(fe.search),T(fe.zoom),j(fe.align)}function le(){te(),ae()}function ae(){e.location.reload()}const ce=e=>t.getElementById(e);await n.enable();let fe=ee();const ue=await p(fe.firmware2);g(ue),t.body.addEventListener("keydown",o),t.body.addEventListener("keyup",i),ce("connected").addEventListener("click",c),ce("disconnected").addEventListener("click",c);let de=null,he=null;ce("zoom").addEventListener("input",S),ce("align").addEventListener("click",$),ce("search").addEventListener("blur",D),ce("search").addEventListener("input",K),ce("previous").addEventListener("click",R),ce("next").addEventListener("click",X),ce("random").addEventListener("click",Y),e.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",ne),e.addEventListener("resize",re),se()})(window,document,WebMidi);